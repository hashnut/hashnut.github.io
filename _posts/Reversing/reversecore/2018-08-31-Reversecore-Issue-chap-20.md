---

layout : single
title : "Reversecore chap 20 - 인라인 패치 실습"
categories : [Reversing]
tags : [reversecore]
comment : true

---

### '리버싱 핵심 원리'의 내용 및 이슈들과 해결책을 다룹니다.

---

<br/>


실행 압축되거나 암호화된 파일을 패치할 때 자주 사용되는 인라인 패치(Inline Patch) 기법을 실습해 보자.


---

### 인라인 패치

인라인 코드 패치(Inline Code Patch) 혹은 줄여서 인라인 패치(Inline Patch)라고 하는 기법은 원하는 코드를 직접 수정하기 어려울 때 간단히 코드 케이브(Code Cave)라고 하는 패치 코드를 삽입한 후 실행해 프로그램을 패치시키는 기법이다. 주로 대상 프로그램이 실행 압축(혹은 암호화)되어 있어서 파일을 직접 수정하기 어려운 경우 많이 사용하는 기법이다.


![i1](https://user-images.githubusercontent.com/26838115/45533031-3a8c9480-b831-11e8-814b-6f2702d2ef96.png)

위 그림처럼 전형적인 실행 압축(또는 암호화) 코드가 있다고 해 보자. EP(Entry Point)코드는 암호화된 OEP(Original Entry Point) 코드를 복호화한 후 OEP 코드로 점프한다. 만약 우리가 패치하길 원하는 코드가 암호화된 OEP 영역에 존재한다면(위치를 알고 있다고 하더라도) 그냥은 패치시키기 어렵다. 복호화 과정에서 엉뚱하게 복호화되기 때문이다.

위와 같은 문제를 해결하기 위해, 코드 케이브라고 하는 별도의 패치 코드를 설치한 후 EP 코드의 복호화 과정 이후 JMP 명령어를 수정하여 코드 케이브가 실행되도록 한다. 그리고 코드 케이브 내에 패치 코드를 실행 후(이미 OEP는 복호화되었기 때문에 그대로 수정 가능) OEP로 가면 된다. 즉 실행될 때마다 (별도의 패치 코드를 실행해) 매번 프로세스 메모리의 코드를 패치하기 때문에 이러한 패치 기법을 인라인 코드 패치(혹은 인라인 패치)라고 부르는 것이다. 이것이 바로 일반적인 코드 패치 방법과 다른 점이다.

  | 코드 패치 | 인라인 패치
|:-----|:-----|:----|
대상 | 파일 | 파일 & 메모리
횟수 | 1번 | 파일에는 1번만, 메모리는 실행될 때마다
방법 | Direct(원하는 위치에 직접 패치) | Indirect (코드 케이브를 미리 설치한 후 메모리에서 원하는 영역이 복호화되었을 때 패치)


---
























